<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè h√†ng & Theo d√µi ƒë∆°n h√†ng</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    </head>
<body>
    <header>üõí Gi·ªè H√†ng C·ªßa B·∫°n</header>
    <div class="container">

        <div class="progress" id="order-progress">
            <div class="progress-step active" data-step="basket">Trong Gi·ªè H√†ng</div>
            <div class="progress-step" data-step="processed">ƒê√£ X·ª≠ L√Ω</div>
            <div class="progress-step" data-step="delivery">ƒêang Giao H√†ng</div>
            <div class="progress-step" data-step="delivered">ƒê√£ Giao H√†ng</div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th>Gi√°</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>T·ªïng</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="S·∫£n ph·∫©m">
                        <img src="images/flower.png" alt="Hoa">
                        <span>Hoa</span>
                    </td>
                    <td data-label="Gi√°" data-price="999000">999.000‚Ç´</td>
                    <td data-label="S·ªë l∆∞·ª£ng" class="quantity">
                        <input type="number" value="1" min="0">
                    </td>
                    <td data-label="T·ªïng" class="item-total">999.000‚Ç´</td>
                    <td><button class="btn btn-remove">‚ùå</button></td>
                </tr>
                
            </tbody>
        </table>

        <div class="cart-summary">
            <p>T·∫°m t√≠nh: <strong id="subtotal">999.000‚Ç´</strong></p> 
            <p>Ph√≠ v·∫≠n chuy·ªÉn: <strong id="shipping">30.000‚Ç´</strong></p>
            <p class="total">T·ªïng c·ªông: <strong id="total">930.000‚Ç´</strong></p>
        </div>

        <div class="actions">
            <button class="btn btn-continue">‚¨Ö Ti·∫øp t·ª•c mua s·∫Øm</button>
            <button class="btn btn-checkout" onclick="checkout()">Ti·∫øn h√†nh thanh to√°n ‚û°</button>
        </div>
    </div>

    <script>
        const subtotalEl = document.getElementById('subtotal');
    const shippingEl = document.getElementById('shipping');
    const totalEl = document.getElementById('total');
    const progressSteps = document.querySelectorAll('.progress-step');

    const shippingFee = 30000;
    let currentStatus = 'basket';

    function formatCurrency(number) {
        // ƒê·∫£m b·∫£o s·ªë l√† s·ªë nguy√™n d∆∞∆°ng
        const safeNumber = Math.max(0, number);
        // S·ª≠ d·ª•ng Intl.NumberFormat ƒë·ªÉ ƒë·ªãnh d·∫°ng t·ªët h∆°n
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(safeNumber).replace('‚Ç´', '') + '‚Ç´';
    }

    /**
     * C·∫≠p nh·∫≠t t·ªïng ti·ªÅn c·ªßa gi·ªè h√†ng.
     * H√†m n√†y lu√¥n t√¨m l·∫°i c√°c h√†ng s·∫£n ph·∫©m m·ªõi nh·∫•t trong b·∫£ng.
     */
    function updateCart() {
        // L·∫•y l·∫°i danh s√°ch c√°c h√†ng hi·ªán t·∫°i trong gi·ªè h√†ng
        const currentRows = document.querySelectorAll('tbody tr');
        let subtotal = 0;

        currentRows.forEach(row => {
            const priceEl = row.querySelector('td[data-price]');
            if (!priceEl) return; 

            // L·∫•y gi√° tr·ªã t·ª´ data-price (s·ªë nguy√™n)
            const price = parseInt(priceEl.dataset.price);
            const inputEl = row.querySelector('input');
            if (!inputEl) return; 

            let quantity = parseInt(inputEl.value);

            // Bu·ªôc s·ªë l∆∞·ª£ng ph·∫£i >= 0
            if (isNaN(quantity) || quantity < 0) {
                quantity = 0;
                inputEl.value = 0;
            }
            
            const total = price * quantity;

            // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn cho t·ª´ng s·∫£n ph·∫©m
            const itemTotalEl = row.querySelector('.item-total');
            if (itemTotalEl) {
                itemTotalEl.innerText = formatCurrency(total);
            }
            subtotal += total;
        });

        // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn t·∫°m t√≠nh v√† t·ªïng c·ªông
        subtotalEl.innerText = formatCurrency(subtotal);
        totalEl.innerText = formatCurrency(subtotal + shippingFee);
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t thanh to√°n (v√≠ d·ª•: t·∫Øt/m·ªü n·∫øu gi·ªè tr·ªëng)
        const checkoutBtn = document.querySelector('.btn-checkout');
        if (checkoutBtn) {
             checkoutBtn.disabled = (subtotal === 0);
             checkoutBtn.style.opacity = (subtotal === 0) ? 0.6 : 1;
        }
    }

    function updateProgress(status) {
        const statuses = ['basket', 'processed', 'delivery', 'delivered'];
        const currentIndex = statuses.indexOf(status);

        progressSteps.forEach((step, index) => {
            step.classList.remove('active');
            if (index <= currentIndex) {
                step.classList.add('active');
            }
        });
        currentStatus = status;
    }

    // M√¥ ph·ªèng qu√° tr√¨nh thanh to√°n v√† chuy·ªÉn tr·∫°ng th√°i
    function checkout() {
        // L·∫•y gi√° tr·ªã subtotal t·ª´ DOM (c√°ch l·∫•y n√†y kh√¥ng l√Ω t∆∞·ªüng, n√™n d√πng bi·∫øn subtotal trong updateCart)
        // C√°ch l·∫•y an to√†n h∆°n: 
        const subtotalText = subtotalEl.innerText.replace(/[‚Ç´\.]/g, '');
        const subtotalValue = parseInt(subtotalText.trim()); 
        
        if (subtotalValue === 0 || isNaN(subtotalValue)) {
            alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m.');
            return;
        }

        if(currentStatus === 'basket') {
            alert('ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ti·∫øp nh·∫≠n v√† x·ª≠ l√Ω!');
            updateProgress('processed'); // Chuy·ªÉn sang tr·∫°ng th√°i "ƒê√£ x·ª≠ l√Ω"
        }
        
        // M√¥ ph·ªèng c√°c tr·∫°ng th√°i ti·∫øp theo sau m·ªôt kho·∫£ng th·ªùi gian
        setTimeout(() => {
            if(currentStatus === 'processed') {
                alert('ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c giao!');
                updateProgress('delivery'); // Chuy·ªÉn sang tr·∫°ng th√°i "ƒêang giao h√†ng"
            }
        }, 3000); 
        
        setTimeout(() => {
            if(currentStatus === 'delivery') {
                alert('ƒê∆°n h√†ng ƒë√£ giao th√†nh c√¥ng!');
                updateProgress('delivered'); // Chuy·ªÉn sang tr·∫°ng th√°i "ƒê√£ giao h√†ng"
            }
        }, 8000);
    }

    /**
     * Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán cho gi·ªè h√†ng
     */
    function setupCartEvents() {
        const currentRows = document.querySelectorAll('tbody tr');
        
        currentRows.forEach(row => {
            const input = row.querySelector('input');
            const removeBtn = row.querySelector('.btn-remove');

            // C·∫≠p nh·∫≠t gi·ªè h√†ng khi thay ƒë·ªïi s·ªë l∆∞·ª£ng
            if (input) {
                // X√≥a c√°c event listener c≈© (n·∫øu c√≥) tr∆∞·ªõc khi th√™m c√°i m·ªõi
                input.removeEventListener('change', updateCart);
                input.removeEventListener('input', updateCart);
                
                input.addEventListener('change', updateCart);
                input.addEventListener('input', updateCart); // X·ª≠ l√Ω s·ª± ki·ªán nh·∫≠p li·ªáu tr·ª±c ti·∫øp
            }

            // G·ª° s·∫£n ph·∫©m khi b·∫•m n√∫t ‚ùå
            if (removeBtn) {
                 // X√≥a c√°c event listener c≈© (n·∫øu c√≥) tr∆∞·ªõc khi th√™m c√°i m·ªõi
                removeBtn.removeEventListener('click', handleRemoveItem);
                
                removeBtn.addEventListener('click', handleRemoveItem);
            }
        });
    }

    function handleRemoveItem(event) {
        // L·∫•y h√†ng (tr) ch·ª©a n√∫t b·∫•m
        const row = event.currentTarget.closest('tr');
        if (row) {
            row.remove(); // X√≥a h√†ng kh·ªèi b·∫£ng
            updateCart(); // C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn
            // C·∫ßn ch·∫°y l·∫°i setupCartEvents n·∫øu b·∫°n th√™m s·∫£n ph·∫©m m·ªõi.
            // Trong tr∆∞·ªùng h·ª£p x√≥a, ch·ªâ c·∫ßn updateCart l√† ƒë·ªß.
        }
    }


    // Kh·ªüi t·∫°o
    document.addEventListener('DOMContentLoaded', () => {
        // G·∫Øn s·ª± ki·ªán l·∫ßn ƒë·∫ßu
        setupCartEvents();
        // T√≠nh l·∫ßn ƒë·∫ßu
        updateCart();
        // Hi·ªÉn th·ªã tr·∫°ng th√°i "Trong Gi·ªè H√†ng" ban ƒë·∫ßu
        updateProgress(currentStatus); 
    });
    </script>
</body>
</html>